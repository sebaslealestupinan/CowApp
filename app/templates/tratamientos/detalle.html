{% extends "base.html" %}

{% block title %}Detalle de Tratamiento - Cow App{% endblock %}

{% block content %}
<div class="columns">
    <div class="column is-half">
        <div class="card">
            <header class="card-header">
                <p class="card-header-title">Información del Tratamiento</p>
            </header>
            <div class="card-content">
                <div class="content" id="tratamientoInfo">
                    <p>Cargando...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="column is-half">
        <div class="box">
            <h2 class="title is-4">Eventos / Seguimiento</h2>
            <button class="button is-small is-info mb-3">Registrar Evento</button>
            <div id="eventosList">
                <p>Cargando eventos...</p>
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="tratamientoId" value="{{ tratamiento_id }}">

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tratamientoId = document.getElementById('tratamientoId').value;
        loadTratamientoDetails(tratamientoId);
        loadEventos(tratamientoId);
    });

    async function loadTratamientoDetails(id) {
        try {
            const response = await fetch(`/tratamientos/${id}`);
            if (!response.ok) throw new Error('Tratamiento no encontrado');
            const t = await response.json();

            const infoDiv = document.getElementById('tratamientoInfo');
            infoDiv.innerHTML = `
                <p><strong>Nombre:</strong> ${t.nombre_tratamiento}</p>
                <p><strong>Diagnóstico:</strong> ${t.diagnostico}</p>
                <p><strong>Medicamento:</strong> ${t.medicamento}</p>
                <p><strong>Dosis:</strong> ${t.dosis}</p>
                <p><strong>Fecha Inicio:</strong> ${t.fecha_inicio}</p>
                <p><strong>Fecha Fin:</strong> ${t.fecha_fin}</p>
                <p><strong>Estado:</strong> <span class="tag ${t.estado === 'Activo' ? 'is-warning' : 'is-success'}">${t.estado}</span></p>
                <p><strong>Veterinario ID:</strong> ${t.veterinario_id}</p>
                <p><strong>Animal ID:</strong> <a href="/views/animales/${t.animal_id}">${t.animal_id}</a></p>
            `;
        } catch (e) {
            document.getElementById('tratamientoInfo').innerHTML = '<p class="has-text-danger">Error al cargar información.</p>';
            console.error(e);
        }
    }

    async function loadEventos(tratamientoId) {
        try {
            const response = await fetch(`/eventos/tratamiento/${tratamientoId}`);
            const eventos = await response.json();

            const listDiv = document.getElementById('eventosList');
            if (eventos.length === 0) {
                listDiv.innerHTML = '<p>No hay eventos registrados.</p>';
                return;
            }

            let html = '<div class="timeline">';
            eventos.forEach(e => {
                html += `
                    <div class="box mb-2">
                        <p><strong>${e.fecha}</strong> - ${e.tipo}</p>
                        <p>${e.observaciones}</p>
                        <p class="is-size-7 has-text-grey">Responsable: ${e.responsable}</p>
                    </div>
                `;
            });
            html += '</div>';
            listDiv.innerHTML = html;

        } catch (e) {
            document.getElementById('eventosList').innerHTML = '<p>Error al cargar eventos.</p>';
            console.error(e);
        }
    }
</script>
{% endblock %}